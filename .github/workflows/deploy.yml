name: Deploy to Firebase Hosting

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test file structure
      run: |
        echo "Checking required files..."
        ls -la
        [ -f index.html ] && echo "âœ“ index.html exists" || exit 1
        [ -f admin.html ] && echo "âœ“ admin.html exists" || exit 1
        [ -f firebase-config.js ] && echo "âœ“ firebase-config.js exists" || exit 1
        [ -f style.css ] && echo "âœ“ style.css exists" || exit 1
        echo "All required files are present!"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Create service account file
      run: |
        echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > service-account.json
        # éªŒè¯ JSON æ–‡ä»¶æ ¼å¼
        jq empty service-account.json
        
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        
    - name: Deploy to Firebase Hosting
      run: |
        firebase use ${{ secrets.FIREBASE_PROJECT_ID }}
        firebase deploy --only hosting --non-interactive
        
    - name: Post-deployment test
      run: |
        echo "ğŸš€ Deployment successful!"
        echo "ğŸ“± User Registration: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
        echo "ğŸ’» Admin Panel: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/admin.html"
        echo " "
        echo "è¯·å°†ä»¥ä¸Šé“¾æ¥æä¾›ç»™ä¼Šæ‹‰å…‹å›¢é˜Ÿä½¿ç”¨"
